# Configure protections in Microsoft Defender security technologies

## Configure policies for Microsoft Defender for Cloud Apps

**Overview:**
- Microsoft Defender for Cloud Apps enables the creation of policies to monitor and control app behaviors, ensuring compliance and security.

**Types of Policies:**
1. **Access Policies:**
   - Control user access to cloud apps based on conditions like user identity, location, and device compliance.
2. **Activity Policies:**
   - Monitor specific user activities within cloud apps to detect unusual behavior or violations of organizational policies. 
3. **File Policies:**
   - Manage and protect sensitive information by monitoring file activities and enforcing data protection policies. 
4. **Anomaly Detection Policies:**
   - Utilize machine learning to identify unusual app behavior and potential security threats. 

**Steps to Configure Policies:**
1. **Access the Policy Management Portal:**
   - Navigate to the Microsoft Defender portal.
   - Go to **Cloud Apps** > **Policies** > **Policy management**.
2. **Create a New Policy:**
   - Select **Create policy** and choose the desired policy type (e.g., Access policy, Activity policy).
   - Fill in policy details such as name, description, and specific conditions.
3. **Define Policy Conditions:**
   - Set filters and conditions based on user groups, app types, activities, or file properties.
4. **Set Actions and Alerts:**
   - Determine the actions to take when a policy is violated, such as sending alerts or restricting access.
5. **Save and Monitor:**
   - Save the policy and monitor its effectiveness through the policy management dashboard.

**Best Practices:**
- **Use Policy Templates:**
  - Leverage predefined policy templates to quickly implement standard policies. 
- **Regularly Review and Update Policies:**
  - Periodically assess and adjust policies to adapt to evolving security requirements.
- **Scope Policies Appropriately:**
  - Apply policies to specific user groups or apps to minimize false positives and enhance relevance.
- **Integrate with Conditional Access:**
  - Combine Defender for Cloud Apps policies with Conditional Access to enforce real-time controls. 
- **Monitor Policy Alerts:**
  - Regularly review alerts generated by policies to promptly address potential security issues.

*Note:* Proper configuration and management of policies in Microsoft Defender for Cloud Apps are crucial for maintaining a secure and compliant cloud environment.

ðŸ“Œ Source: [Learn about app policies with app governance](https://learn.microsoft.com/en-us/defender-cloud-apps/app-governance-app-policies-overview)

---
## Configure policies for Microsoft Defender for Office 365

**Overview**
- Microsoft Defender for Office 365 provides preset security policies to streamline the implementation of recommended security settings. These presets, namely Standard and Strict, are designed to safeguard your organization against various threats.

**Preset Security Policies**
- **Standard Preset Security Policy**:
  - Offers balanced protection suitable for most organizations.
  - Applies recommended settings for anti-phishing, anti-spam, and anti-malware.
- **Strict Preset Security Policy**:
  - Provides enhanced protection for high-risk environments.
  - Implements more aggressive threat mitigation settings.

**Configuring Preset Security Policies**
1. **Access the Microsoft Defender Portal**:
   - Navigate to Defender portal.
   - Go to **Email & Collaboration** > **Policies & Rules** > **Threat policies** > **Preset Security Policies**.
2. **Assign a Preset Security Policy**:
   - Select **Standard protection** or **Strict protection**.
   - Click on **Manage protection settings** to initiate the configuration wizard.
3. **Define Recipients**:
   - Choose to apply the policy to **All recipients** or **Specific recipients**.
   - For specific recipients, specify users, groups, or domains.
4. **Review and Apply**:
   - Verify the configuration settings.
   - Click **Confirm** to apply the policy.

**Additional Considerations**
- **Policy Hierarchy**:
  - Preset security policies take precedence over custom policies.
  - If both Standard and Strict policies are applied, the Strict policy settings override the Standard ones.
- **Exclusions**:
  - It's possible to add exclusions, but it's generally not recommended as it may reduce protection effectiveness.
- **Monitoring and Adjustments**:
  - Regularly monitor the impact of these policies.
  - Adjust assignments as necessary to maintain optimal security without hindering productivity.

ðŸ“Œ Source: [Preset security policies in EOP and Microsoft Defender for Office 365](https://learn.microsoft.com/en-us/defender-office-365/preset-security-policies)

---
## Configure security policies for Microsoft Defender for Endpoints, including attack surface reduction (ASR) rules

**Overview**
- **Microsoft Defender for Endpoint (MDE)**: A comprehensive endpoint security solution offering advanced threat protection and attack surface reduction.

**Attack Surface Reduction (ASR) Rules**
- **Purpose**: Mitigate threats by restricting actions and behaviors commonly used by malware.
- **Configuration Methods**:
  - **Endpoint Security Policy (Preferred)**:
    - Navigate to **Endpoint Security > Attack surface reduction** in the Microsoft Intune admin center.
    - Create or select an existing policy.
    - For new policies, choose **Attack Surface Reduction Rules** as the profile type.
    - Configure desired ASR rules.
    - Assign the policy to target devices or groups.
  - **Device Configuration Profiles (Alternative)**:
    - Go to **Device configuration > Profiles** in Intune.
    - Create a new profile with **Endpoint protection** as the profile type.
    - Configure ASR rules under the **Microsoft Defender Exploit Guard** section.
    - Assign the profile to appropriate devices or groups.

**Best Practices**
- **Audit Mode Evaluation**:
  - Initially deploy ASR rules in audit mode to assess potential impacts.
  - Monitor audit logs to identify legitimate applications that might be affected.
  - Adjust rules or create exclusions based on findings.
- **User Notifications**:
  - Configure notifications to inform users when content is blocked by ASR rules.
  - Provide options for users to unblock content if necessary.
  - Note: Some ASR rules may not support user override functionality.
- **Advanced Hunting**:
  - Utilize advanced hunting queries in the Microsoft Defender portal to analyze ASR rule events.
  - Focus on unique processes per hour to streamline data analysis.
- **Platform Support**:
  - Ensure devices run supported versions of Windows (e.g., Windows 10 Pro version 1709 or later) for ASR rule applicability.
  - Verify that Windows Server versions are onboarded correctly to support ASR features.

ðŸ“Œ Source: [Learn how to use Intune endpoint security policies to manage Microsoft Defender for Endpoint on devices that are not enrolled with Intune](https://learn.microsoft.com/en-us/mem/intune-service/protect/mde-security-integration?toc=%2Fdefender-endpoint%2Ftoc.json&bc=%2Fdefender-endpoint%2Fbreadcrumb%2Ftoc.json)

---
## Configure cloud workload protections in Microsoft Defender for Cloud

**Overview**
- Microsoft Defender for Cloud offers comprehensive security measures to protect various cloud workloads. The **Workload Protections Dashboard** provides an interactive interface to monitor and manage these protections.

**Key Components of the Workload Protections Dashboard**
1. **Defender for Cloud Coverage**:
   - Displays resource types in your subscription eligible for protection.
   - Allows upgrading of resources to enhance security measures.
   - Option to upgrade all eligible resources simultaneously.
2. **Security Alerts**:
   - Lists detected threats within your environment.
   - Provides details of affected resources and suggested remediation steps.
   - Some alerts offer the option to trigger automated responses via logic apps.
3. **Advanced Protection**:
   - Showcases the status of resources concerning various protection types, including:
     - Virtual Machines
     - SQL Databases
     - Containers
     - Web Applications
     - Network Security
   - Direct links to configuration areas for each protection type.
4. **Insights**:
   - Offers news, suggested readings, and highlights high-priority alerts relevant to your environment.

**Prerequisites**
- Ensure that the Defender for Cloud plan is enabled at the **subscription level**.
- Resources onboarded at the **resource level** alone won't fully benefit from the capabilities available through the Workload Protection blade.

**Best Practices**
- **Regular Monitoring**:
  - Consistently review the Workload Protections Dashboard to stay informed about the security status of your resources.
- **Timely Remediation**:
  - Address security alerts promptly to mitigate potential threats.
- **Comprehensive Coverage**:
  - Upgrade all eligible resources to ensure they are protected under Defender for Cloud's advanced security features.
- **Stay Informed**:
  - Utilize the Insights section to keep abreast of the latest security news and recommendations pertinent to your environment.

ðŸ“Œ Source: [Review workload protection](https://learn.microsoft.com/en-us/azure/defender-for-cloud/workload-protections-dashboard)

---
# Configure detections in Microsoft Defender XDR

## Configure and manage custom detection rules

**Overview**
- Custom detection rules in Microsoft Defender XDR allow proactive monitoring of events and system states, including suspected breach activities and misconfigurations. These rules, based on advanced hunting queries, run at regular intervals to generate alerts and initiate response actions upon detecting matches. :contentReference[oaicite:0]{index=0}

**Prerequisites**
- **Permissions**: To manage custom detections, ensure you have one of the following roles:
  - Security settings (manage)
  - Security Administrator
  - Security Operator (with 'Manage Security Settings' permission if RBAC is enabled)
- These roles grant the necessary permissions to create and manage detection rules within the Microsoft Defender portal.

**Creating a Custom Detection Rule**
1. **Prepare the Query**:
   - Navigate to the Advanced Hunting section in the Microsoft Defender portal.
   - Select or craft a query that identifies the desired events or system states.
   - Run the query to validate its accuracy and ensure it returns appropriate results.
   - Ensure the query includes the following columns:
     - `Timestamp`
     - Columns that uniquely identify the event, such as `DeviceId` and `ReportId` for Defender for Endpoint tables.
2. **Define Rule Details**:
   - With the validated query, select 'Create detection rule'.
   - Specify the following alert details:
     - **Detection name**: A unique identifier for the rule.
     - **Frequency**: Interval at which the query runs (e.g., every 15 minutes, hourly).
     - **Alert title**: The title displayed for alerts triggered by this rule.
     - **Severity**: The potential risk level associated with the detected activity.
3. **Select Impacted Entities**:
   - Identify the columns in your query results that represent the main affected entities.
   - This step aids in aggregating relevant alerts, correlating incidents, and targeting response actions effectively.

**Managing Custom Detection Rules**
- **View Rule Details**:
  - Navigate to 'Hunting' > 'Custom detection rules' in the Microsoft Defender portal.
  - Select a rule to view its general information, run status, scope, and a list of triggered alerts and actions.
- **Modify or Run Rules**:
  - From the rule's details page, you can:
    - Edit the rule's configuration.
    - Manually run the rule.
    - Enable or disable the rule.
    - Delete the rule if it's no longer needed.

**Best Practices**
- **Optimize Queries**:
  - Refine queries to minimize false positives and avoid generating alerts for routine activities.
  - Each rule is limited to generating 100 alerts per run; ensure queries are specific to maintain relevance.
- **Regular Review**:
  - Periodically assess and update detection rules to align with evolving security threats and organizational changes.
- **Collaborate Across Teams**:
  - Work with different security teams to ensure detection rules cover various threat vectors and organizational needs.

ðŸ“Œ Source: [Create and manage custom detections rules](https://learn.microsoft.com/en-us/defender-xdr/custom-detection-rules)

---
## Manage alerts, including tuning, suppression, and correlation

**Alert Tuning and Suppression**
  - **Purpose**: Reduce false positives and streamline alert management.
  - **Creating Suppression Rules**:
    - Select an alert to suppress.
    - In the alert management pane, choose "Create a suppression rule."
    - Define conditions based on alert title, indicators of compromise, or other attributes.
    - Specify actions and scope for the rule.
    - Regularly review and update suppression rules to ensure effectiveness.

**Alert Correlation**
  - **Function**: Aggregate related alerts into incidents for comprehensive analysis.
  - **Process**:
    - The correlation engine groups alerts from various sources.
    - Incidents are formed to provide broader context of attacks.
    - Continuous monitoring allows merging of incidents as new information emerges.

**Best Practices**
  - Regularly monitor and adjust suppression rules to adapt to evolving threats.
  - Utilize the correlation engine to understand the full scope of security incidents.
  - Engage with security operations teams to prioritize investigation and remediation efforts.

ðŸ“Œ Source: [Investigate alerts in Microsoft Defender XDR](https://learn.microsoft.com/en-us/defender-xdr/investigate-alerts?tabs=settings)

---
## Configure deception rules in Microsoft Defender XDR

**Enable Deception Capability**
  - Navigate to **Settings > Endpoints > Advanced features**.
  - Toggle **Deception capabilities** to **On**.
  - A default rule is automatically created and deployed to all Windows client devices. 

**Create a Deception Rule**
  1. Go to **Settings > Endpoints > Deception rules**.
  2. Click **Add deception rule**.
  3. Provide a **Rule name** and **Description**.
  4. Select **Lure types**:
     - **Basic lures**: Planted documents or link files with minimal interaction.
     - **Advanced lures**: Content like cached credentials that interact with the environment.
  5. Define the **Scope** by selecting target devices (all Windows clients or specific tags).
  6. Review **Automatically generated decoys** (accounts and hosts):
     - Ensure decoy names/IPs do not conflict with existing organizational assets to prevent false positives.
  7. Optionally, **Add custom lures**:
     - Upload files (excluding .DLL and .EXE; max 10 MB).
     - Specify the **Path** for lure placement.
     - Decide if the lure should be **Hidden**.
  8. Review and **Save** the rule.

**Deployment Considerations**
  - Rule deployment may take **12-24 hours**.
  - Monitor the **Status** in the Deception rules pane.

**Best Practices**
  - Use unique decoy account and host names to avoid conflicts.
  - Regularly review and update deception rules to adapt to evolving threats.
  - Test deception rules in a controlled environment before broad deployment.

ðŸ“Œ Source: [Configure the deception capability in Microsoft Defender XDR](https://learn.microsoft.com/en-us/defender-xdr/configure-deception)

---
# 	- Configure detections in Microsoft Sentinel

## Classify and analyze data by using entities

**Definition of Entities**
  - Entities are classifications or labels for data elements in Microsoft Sentinel alerts.

**Entity Categories**
  - **Assets**: Internal, protected, or inventoried objects (e.g., Accounts, Hosts, Mailboxes, Azure resources).
  - **Other Entities (Evidence)**: External items or indicators of compromise (e.g., IP addresses, Files, Processes, URLs).

**Supported Entity Types**
  - Account, Host, IP address, URL, Azure resource, Cloud application, DNS resolution, File, File hash, Malware, Process, Registry key, Registry value, Security group, Mailbox, Mail cluster, Mail message, Submission mail.

**Entity Identifiers**
  - **Strong Identifiers**: Uniquely identify an entity (e.g., Microsoft Entra account's GUID).
  - **Weak Identifiers**: May not uniquely identify an entity in all cases; combining multiple weak identifiers can form a strong identifier.

**Entity Mapping in Analytics Rules**
  - Map data fields in tables to Microsoft Sentinel entities to enhance incident information.
  - **Steps**:
    1. Navigate to **Analytics** in Microsoft Sentinel.
    2. Select or create a new analytics rule.
    3. In the **Set rule logic** section, define the query and map relevant data fields to entity types.
    4. Save and enable the rule.

**Entity Pages**
  - Provide detailed information about specific entities, including related alerts, incidents, and activities.
  - **Access**:
    - Click on an entity link within an alert or incident to view its entity page.

**Best Practices**
  - Ensure alert providers properly identify entities using strong identifiers to facilitate accurate entity merging.
  - Regularly review and update entity mappings to maintain effective data classification and analysis.

ðŸ“Œ Source: [Entities in Microsoft Sentinel](https://learn.microsoft.com/en-us/azure/sentinel/entities)

---
## Configure and manage analytics rules

**Analytics Rules Overview**
  - Automate threat detection by running queries on collected data to identify security threats.
  - Generate alerts upon detecting suspicious activities, which are then aggregated into incidents for investigation.

**Types of Analytics Rules**
  - **Scheduled Rules**: Run Kusto Query Language (KQL) queries at set intervals to analyze data over a specified lookback period.
  - **Near-Real-Time (NRT) Rules**: Execute every minute for up-to-date threat detection, similar to scheduled rules but with higher frequency.
  - **Anomaly Rules**: Utilize machine learning to identify deviations from typical patterns.
  - **Microsoft Security Rules**: Integrate alerts from other Microsoft security products. 

**Creating Analytics Rules**
  - **From Templates**:
    1. Navigate to **Analytics** under the **Configuration** section in Microsoft Sentinel.
    2. Select the **Rule templates** tab.
    3. Choose a template and click **Create rule**.
    4. Customize the rule settings as needed and save.
  - **From Scratch**:
    1. In **Analytics**, select **+ Create** and choose **Scheduled query rule**.
    2. Define rule details, set the query logic using KQL, and configure scheduling and thresholds.
    3. Specify incident settings, automated responses, and review before creating the rule.

**Managing Analytics Rules**
  - **Viewing Active Rules**: Access the **Active rules** tab in the **Analytics** section to monitor and manage existing rules.
  - **Editing Rules**: Select a rule from the list to modify its configuration, query logic, or scheduling.
  - **Disabling/Enabling Rules**: Toggle the rule's status to control its activity without deleting it.

**Best Practices**
  - Regularly review and update analytics rules to adapt to evolving threats.
  - Utilize rule templates from the Content hub for commonly used detection scenarios.
  - Customize rules to align with your organization's specific security requirements.
  - Test new or modified rules in a controlled environment before deploying them broadly.

ðŸ“Œ Source: [Threat detection in Microsoft Sentinel](https://learn.microsoft.com/en-us/azure/sentinel/threat-detection)

---
## Query Microsoft Sentinel data by using ASIM parsers

**Advanced Security Information Model (ASIM) Overview**
  - ASIM provides a unified framework for normalizing security data across various sources in Microsoft Sentinel.
  - It utilizes Kusto Query Language (KQL) functions, known as parsers, to transform raw data into standardized schemas.

**Types of ASIM Parsers**
  - **Unifying Parsers**: Serve as a central point, invoking source-specific parsers to aggregate data into a common schema.
  - **Source-Specific Parsers**: Handle the normalization of data from specific sources, ensuring compatibility with the unified schema.

**Parser Naming Conventions**
  - **Built-in Parsers**:
    - Unifying: `_Im_<Schema>` (e.g., `_Im_Dns`)
    - Source-Specific: `_Im_<Schema>_<Source>` (e.g., `_Im_Dns_InfobloxNIOS`)
  - **Workspace-Deployed Parsers**:
    - Unifying: `im<Schema>`
    - Source-Specific: `vim<Schema><Source>`

**Using ASIM Parsers in Queries**
  - Replace direct table references with the appropriate unifying parser to access normalized data.
  - **Example**: To query DNS logs across various sources:
    ```kql
    _Im_Dns
    | where DnsQuery contains "malicious.com"
    ```
    This approach ensures that DNS data from all integrated sources is queried uniformly.

**Benefits of Using ASIM Parsers**
  - Simplifies queries by abstracting source-specific details.
  - Enhances the consistency and reliability of security analyses.
  - Facilitates the creation of reusable and scalable security content.

**Best Practices**
  - Utilize built-in parsers when available for standardized schemas.
  - Deploy workspace-specific parsers for sources not covered by built-in options.
  - Regularly update and manage parsers to adapt to new data sources and formats.

ðŸ“Œ Source: [The Advanced Security Information Model (ASIM) parsers (Public preview)](https://learn.microsoft.com/en-us/azure/sentinel/normalization-parsers-overview)

---
## Implement behavioral analytics

**Behavioral Analytics Overview**
  - Detect threats by analyzing **entity behaviors** (users, devices, etc.) based on deviations from normal activity patterns.
  - Utilizes **machine learning** and **statistical models** to identify unusual or suspicious activities.
  - Helps identify potential insider threats, compromised accounts, and lateral movement.

**Key Concepts**
  - **Entities**: Users, devices, IP addresses, and other network objects.
  - **Behavioral Baseline**: Normal behavior patterns established through continuous monitoring.
  - **Anomalies**: Activities that significantly deviate from the baseline, indicating potential threats.

**Components of Behavioral Analytics**
  - **Entity Behavior Analytics (EBA)**: Uses machine learning to track and analyze entity activities over time.
  - **User and Entity Behavior Analytics (UEBA)**: Focuses specifically on users and devices to detect malicious activity or compromises.
  - **Threat Intelligence**: Enriches entity activity data with threat feeds to enhance detection accuracy.

**Steps for Implementing**
  - **Step 1**: Configure the **Microsoft Sentinel** workspace and enable built-in **Analytics rules**.
  - **Step 2**: Ensure relevant data connectors (like **Azure Active Directory**, **Windows Security**, etc.) are in place.
  - **Step 3**: Define and tune **Analytics rules** using **machine learning models** and **customized entity data**.
  - **Step 4**: Monitor the detected anomalies and integrate with existing workflows for incident response.

**Best Practices**
  - Regularly **tune analytics rules** to minimize false positives.
  - Use **machine learning** to automatically adjust to shifting normal behavior over time.
  - Leverage **threat intelligence** to contextualize anomalies and improve detection accuracy.
  - Focus on high-impact entities (admins, critical infrastructure) for more precise detection.

**Example**
  - **Behavioral Analytics Rule Example**: Identify suspicious login attempts by a user who has deviated from their normal logon patterns.
    ```kql
    SecurityEvent
    | where EventID == 4624 and AccountType == "User"
    | summarize count() by AccountName, bin(TimeGenerated, 1h)
    | where count_ > threshold
    ```

ðŸ“Œ Source: [Advanced threat detection with User and Entity Behavior Analytics (UEBA) in Microsoft Sentinel](https://learn.microsoft.com/en-us/azure/sentinel/identify-threats-with-entity-behavior-analytics)

---

